#X. 后端



##X.1 类定义

- `User` : 用以记录用户的所有信息，包括id、姓名、权限、手机和邮箱等；
- `Train` : 记录车次的所有信息，包括途径站，时间，票种票价等；
- `Station` ：车站类，用以记录某车次经过的该站的信息；
- `Ticket` ： 记录用户某一次购买的若干张车票，包含车次ID，起始站，到达站和票种信息；
- `mytime` ：时间类；
- `tstring` ：用于数据库存储的定长字符串类型；
- `tokenscanner` ： 用于从字符串或者stdin中读取并分离数据；

##X.2 数据库的实现
（TODO）

##X.3 数据的存储
####X.3.0 设计理念
可以使用的工具为一个支持一一对应插入修改和删除的数据库，所以设计时尽可能地将所有数据整合成有唯一关键字的一对一的数据进行存储和处理。绝大多数的数据使用B+树实现的`DB`类存储。(以下出现的含DB的变量均为`DB`类)
####X.3.1 用户信息
原本采用`DB`存储，但用户并没有删除操作，更改为用更加高效的线性表`fvector`存储。
####X.3.2 车次信息
对于车次本身的信息存储于`trainDB`中,同时将所有可能的路线存入`routeDB`。为了实现带中转查询操作，将出现过的车站存储于`staDB`中。
####1.3.3 车票信息
对于用户购买的车票存入`ticketDB`，每个车次每天的余票存储于`train_ticDB`中。

##X.3 操作的实现
####X.3.1 用户操作
直接在对应的线性表中进行插入和修改操作。
####X.3.2 车次操作
进行添加车次操作后在对应的train数据库中加入对应车次的信息，修改和删除操作也对应的在数据库中修改数据。

在进行发售操作后，由于发售后保证不更改车次信息，在车次进行发售操作后将列车所有可能的路线将起始站和到达站以及车次的ID结合，作为一个复合关键字加入route数据库中。
####X.3.3 车票操作
用户查询车票时，就可以将所查询的出发站和到达站结合，分别接上最小可能的车次ID和最大可能的车次ID，使用数据库的区间查找操作找到所有满足条件的车次的ID，并在`trainDB`中找到ID对应的信息并进行输出。

在用户购票后，以用户此次购买的车票构建一个对应的`Ticket`类，以用户ID和日期、catalog和从1开始生成的唯一的TicketID为复合关键字存入`ticketDB`中。同时在`train_ticDB`中以车次ID和日期为复合关键字维护对应的余票信息。

查询购票信息时就可以用查询车票类似的放法，以所查询的用户ID、日期、catalog为复合关键字查找满足条件的所有车票。退票时在数据库中找到对应内容删除。

带中转查询使用的是枚举中转站进行查询车票的方法。

#Y. 个人总结
##姜卫邦
***
**我在本次大作业中主要负责通过后端评测。**

在本次大作业中，我学会了如何将一个很大的问题分散成一些小问题来解决，又如何将这些一个个的操作连在一起。

我首先遇到的一个困难是如何高效率地实现查票操作，我思考通过把经过出发地的列车枚举出来，在这些列车中查找是否经过目的地，但这样的方法似乎比较费时。于是我询问我们的A班组员曾比杨同学，他告诉了我一种较快的实现方法，提高了查票操作的效率。

在写完后端后，我又遇到了调试的困难。由于是文件输入，使得调试起来比较麻烦，花费了我较多时间。最后终于调试成功。

**这次大作业使我获益匪浅。**
##汪伟杰
（TODO）
##曾比扬
（TODO）
##张文涛
（TODO）
